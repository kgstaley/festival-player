#!/bin/bash
# script/build: Build the application for production deployment.

set -e

cd "$(dirname "$0")/.."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
DOCKER_BUILD=false
DOCKER_TAG="latest"
DOCKER_IMAGE="festival-player"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --docker)
            DOCKER_BUILD=true
            shift
            ;;
        --tag)
            DOCKER_TAG="$2"
            shift 2
            ;;
        --image)
            DOCKER_IMAGE="$2"
            shift 2
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Build festival-player for production deployment."
            echo ""
            echo "Options:"
            echo "  --docker         Build production Docker image"
            echo "  --tag TAG        Docker image tag (default: latest)"
            echo "  --image NAME     Docker image name (default: festival-player)"
            echo "  --help           Show this help message"
            echo ""
            echo "Examples:"
            echo "  $0                                    # Local build"
            echo "  $0 --docker                           # Docker build with default tag"
            echo "  $0 --docker --tag v1.0.0              # Docker build with custom tag"
            echo "  $0 --docker --image myapp --tag v1    # Custom image name and tag"
            echo ""
            exit 0
            ;;
        *)
            echo -e "${RED}Error: Unknown option: $1${NC}"
            echo "Run '$0 --help' for usage information"
            exit 1
            ;;
    esac
done

if [ "$DOCKER_BUILD" = true ]; then
    echo "==> Building Docker image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
    echo ""

    # Check if Docker is installed
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Error: Docker is not installed${NC}"
        echo "Please install Docker from https://www.docker.com/get-started"
        exit 1
    fi

    echo -e "${GREEN}✓${NC} Docker $(docker --version | cut -d' ' -f3 | tr -d ',') found"
    echo ""

    # Check for Dockerfile
    if [ ! -f Dockerfile ]; then
        echo -e "${RED}Error: Dockerfile not found${NC}"
        echo "Please ensure Dockerfile exists in the project root"
        exit 1
    fi

    echo "==> Building Docker image..."
    docker build -t "${DOCKER_IMAGE}:${DOCKER_TAG}" .

    echo ""
    echo -e "${GREEN}✓${NC} Docker image built successfully"
    echo ""

    # Show image size
    IMAGE_SIZE=$(docker images "${DOCKER_IMAGE}:${DOCKER_TAG}" --format "{{.Size}}")
    echo "Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
    echo "Size:  ${IMAGE_SIZE}"
    echo ""

    # Provide run instructions
    echo "To run the container:"
    echo -e "${YELLOW}  docker run -p 5000:5000 --env-file .env.docker ${DOCKER_IMAGE}:${DOCKER_TAG}${NC}"
    echo ""
    echo "Or with docker-compose:"
    echo -e "${YELLOW}  docker-compose up${NC}"
    echo ""
else
    echo "==> Building for local production deployment..."
    echo ""

    # Build server
    echo "==> Building server..."
    yarn build

    # Build client
    echo ""
    echo "==> Building client..."
    cd client
    yarn build
    cd ..

    echo ""
    echo -e "${GREEN}✓${NC} Build complete"
    echo ""
    echo "Build artifacts:"
    echo "  Server: dist/"
    echo "  Client: client/build/"
    echo ""
    echo "To start the production server:"
    echo -e "${YELLOW}  ./script/start --production${NC}"
    echo ""
    echo "Or run directly:"
    echo -e "${YELLOW}  yarn server${NC}"
    echo ""
fi
